name: PlatformIO Multi-Platform Docker Builder

on:
  schedule:
    - cron: '0 8 * * *'  # Daily at 8 AM UTC
  workflow_dispatch:

jobs:
  get-version:
    runs-on: ubuntu-22.04
    
    outputs:
      platformio_version: ${{ steps.get-version.outputs.version }}
      build_required: ${{ steps.check-version.outputs.build_required }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Get latest PlatformIO version
      id: get-version
      run: |
        VERSION=$(curl -s https://pypi.org/pypi/platformio/json | grep -o '"version":"[^"]*"' | head -1 | cut -d'"' -f4)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Latest PlatformIO version: $VERSION"
        
    - name: Check if version changed
      id: check-version
      run: |
        if [ -f "version.txt" ]; then
          CURRENT=$(cat version.txt)
          LATEST="${{ steps.get-version.outputs.version }}"
          
          if [ "$CURRENT" = "$LATEST" ]; then
            echo "Version unchanged: $CURRENT"
            echo "build_required=false" >> $GITHUB_OUTPUT
            exit 0
          fi
        fi
        
        echo "New version detected or first run"
        echo "build_required=true" >> $GITHUB_OUTPUT

  build-base-image:
    needs: get-version
    if: needs.get-version.outputs.build_required == 'true'
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Update version file
      run: |
        echo "${{ needs.get-version.outputs.platformio_version }}" > version.txt
        echo "Updated version.txt to: ${{ needs.get-version.outputs.platformio_version }}"
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push base image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/platformio:latest
          ${{ secrets.DOCKIO_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          PLATFORMIO_VERSION=${{ needs.get-version.outputs.platformio_version }}

  build-platform-images:
    needs: [get-version, build-base-image]
    if: needs.get-version.outputs.build_required == 'true'
    
    runs-on: ubuntu-latest
    
    # Matriz de plataformas populares
    strategy:
      matrix:
        platform:
          - name: "espressif32"
            description: "Espressif 32 (ESP32)"
          - name: "espressif8266"
            description: "Espressif 8266 (ESP8266)"
          - name: "atmelavr"
            description: "Atmel AVR (Arduino)"
          - name: "ststm32"
            description: "ST STM32"
          - name: "atmelsam"
            description: "Atmel SAM"
          - name: "teensy"
            description: "Teensy"
          - name: "raspberrypi"
            description: "Raspberry Pi Pico"
          - name: "nordicnrf52"
            description: "Nordic nRF52"
          - name: "nxp"
            description: "NXP"
          - name: "lattice_ice40"
            description: "Lattice iCE40"
          - name: "microchippic32"
            description: "Microchip PIC32"
          - name: "riscv"
            description: "RISC-V"

    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        
    - name: Build and push platform-specific image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-${{ matrix.platform.name }}
          ${{ secrets.DOCKER_USERNAME }}/platformio:${{ matrix.platform.name }}-latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          PLATFORMIO_VERSION=${{ needs.get-version.outputs.platformio_version }}
          PLATFORM_NAME=platformio/${{ matrix.platform.name }}
        labels: |
          org.label-schema.description="PlatformIO with ${{ matrix.platform.description }} platform"
          org.label-schema.version=${{ needs.get-version.outputs.platformio_version }}
          org.label-schema.platform=${{ matrix.platform.name }}
          
    - name: Verify platform installation
      run: |
        echo "Built image with platform: ${{ matrix.platform.name }}"
        echo "Tags:"
        echo "- ${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-${{ matrix.platform.name }}"
        echo "- ${{ secrets.DOCKER_USERNAME }}/platformio:${{ matrix.platform.name }}-latest"

  build-all-platforms-image:
    needs: [get-version, build-base-image]
    if: needs.get-version.outputs.build_required == 'true'
    
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Login to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

  update-repository:
    needs: [get-version, build-base-image, build-platform-images, build-all-platforms-image]
    if: always() && needs.get-version.outputs.build_required == 'true'
    
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Update version file
      run: |
        echo "${{ needs.get-version.outputs.platformio_version }}" > version.txt
        
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add version.txt
        git commit -m "chore: update to PlatformIO v${{ needs.get-version.outputs.platformio_version }}"
        git push

  generate-readme:
    needs: [get-version, build-base-image, build-platform-images]
    if: always() && needs.get-version.outputs.build_required == 'true'
    
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Generate README.md
      run: |
        cat > README.md << 'EOF'
        # PlatformIO Docker Images
        
        ## ðŸš€ Latest Version: ${{ needs.get-version.outputs.platformio_version }}
        
        ## ðŸ“¦ Available Images
        
        ### Base Image
        - `${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}` - PlatformIO Core only
        - `${{ secrets.DOCKER_USERNAME }}/platformio:latest` - Latest version
        
        ### Platform-Specific Images
        
        | Platform | Tag | Description |
        |----------|-----|-------------|
        | **All Platforms** | `${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-complete` | All popular platforms pre-installed |
        | **ESP32** | `${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-espressif32` | Espressif ESP32 |
        | **ESP8266** | `${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-espressif8266` | Espressif ESP8266 |
        | **AVR (Arduino)** | `${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-atmelavr` | Atmel AVR (Arduino) |
        | **STM32** | `${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-ststm32` | ST STM32 |
        | **Teensy** | `${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-teensy` | Teensy |
        | **Raspberry Pi Pico** | `${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-raspberrypi` | Raspberry Pi Pico |
        | **nRF52** | `${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-nordicnrf52` | Nordic nRF52 |
        
        ## ðŸ³ Usage Examples
        
        ### Basic Usage
        ```bash
        # Run PlatformIO commands
        docker run --rm -v $(pwd):/workspace ${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }} pio --help
        
        # Initialize a new project
        docker run --rm -v $(pwd):/workspace ${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }} pio project init --board esp32dev
        ```
        
        ### Platform-Specific Usage
        ```bash
        # ESP32 project
        docker run --rm -v $(pwd):/workspace ${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-espressif32 pio run
        ```
        
        ### Docker Compose Example
        ```yaml
        version: '3'
        services:
          platformio:
            image: ${{ secrets.DOCKER_USERNAME }}/platformio:${{ needs.get-version.outputs.platformio_version }}-espressif32
            volumes:
              - .:/workspace
            working_dir: /workspace
        ```
        
        ## ðŸ”„ Automatic Updates
        
        This repository automatically builds new Docker images when a new version of PlatformIO is released.
        
        ## ðŸ“Š Build Status
        
        ![GitHub Actions](https://github.com/rafacouto/docker-platformio/workflows/PlatformIO%20Multi-Platform%20Docker%20Builder/badge.svg)
        
        ## ðŸ“ License
        
        AGPL-3.0
        EOF
        
    - name: Commit generated README
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add README.md
        git commit -m "docs: update README for v${{ needs.get-version.outputs.platformio_version }}"
        git push
